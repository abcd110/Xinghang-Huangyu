# 代码质量修复计划

## 当前状态

- **总计问题**: 231 个 (173 个错误, 58 个警告)
- **TypeScript 类型检查**: ✅ 通过
- **构建测试**: ✅ 通过

## 问题分类统计

| 问题类型 | 数量 | 严重程度 |
|----------|------|----------|
| React Hooks 不变性错误 | ~50 | 🔴 高 |
| 未使用的变量/导入 | ~80 | 🟡 中 |
| 不纯函数调用 | ~15 | 🟡 中 |
| 组件内创建组件 | ~5 | 🟡 中 |
| useEffect 中直接调用 setState | ~10 | 🟡 中 |
| any 类型使用 | ~30 | 🟡 中 |
| 变量声明顺序问题 | ~5 | 🟢 低 |
| 其他 | ~36 | 🟢 低 |

## 修复计划

### 阶段一：修复 React Hooks 不变性错误（高优先级）

**目标文件**: TestScreen.tsx, PlanetExplorationScreen.tsx, SpaceshipModuleScreen.tsx, BaseScreen.tsx

**问题描述**: 直接修改从 hook 返回的 gameManager 对象
```typescript
// ❌ 错误
const { gameManager } = useGameStore();
gameManager.player.stamina -= 5;

// ✅ 正确
const { gameManager, updatePlayerStamina } = useGameStore();
// 通过 store 中的方法修改
```

**修复步骤**:
1. 识别所有直接修改 gameManager 的代码
2. 在 gameStore 中添加相应的修改方法
3. 替换所有直接修改为调用 store 方法

### 阶段二：清理未使用的变量和导入（中优先级）

**目标文件**: 所有 screen 文件

**修复步骤**:
1. 删除未使用的 import 语句
2. 删除未使用的变量声明
3. 使用 `_` 前缀标记 intentionally unused 的参数

### 阶段三：修复不纯函数调用（中优先级）

**目标文件**: SublimationScreen.tsx, SpaceshipModuleScreen.tsx

**问题描述**: 在渲染期间调用 Math.random() 和 Date.now()

**修复步骤**:
1. 将 Math.random() 调用移到事件处理函数中
2. 将 Date.now() 调用移到 useEffect 或事件处理中

### 阶段四：修复组件内创建组件问题（中优先级）

**目标文件**: BaseScreen.tsx

**问题描述**: 在组件渲染期间定义新组件

**修复步骤**:
1. 将内部组件提取到文件外部
2. 或使用 useMemo 缓存组件定义

### 阶段五：修复 useEffect 中直接调用 setState（中优先级）

**目标文件**: StartScreen.tsx

**问题描述**: 在 useEffect 主体中直接调用 setState

**修复步骤**:
1. 使用 setTimeout 或 requestAnimationFrame 延迟执行
2. 或将逻辑移到事件处理中

### 阶段六：修复变量声明顺序问题（低优先级）

**目标文件**: PlanetExplorationScreen.tsx

**问题描述**: 在声明前使用变量

**修复步骤**:
1. 调整变量声明顺序
2. 或使用函数声明替代函数表达式

## 文件修复优先级

| 优先级 | 文件 | 问题数 | 主要问题 |
|--------|------|--------|----------|
| 🔴 高 | TestScreen.tsx | 25 | Hooks 不变性、未使用导入 |
| 🔴 高 | PlanetExplorationScreen.tsx | 15 | Hooks 不变性、变量顺序 |
| 🔴 高 | SpaceshipModuleScreen.tsx | 15 | Hooks 不变性、不纯函数 |
| 🟡 中 | BaseScreen.tsx | 40 | Hooks 不变性、未使用变量 |
| 🟡 中 | PlayerScreen.tsx | 15 | 未使用变量 |
| 🟡 中 | SublimationScreen.tsx | 10 | 不纯函数、未使用变量 |
| 🟡 中 | StartScreen.tsx | 8 | useEffect setState |
| 🟢 低 | SaveMigration.ts | 8 | 未使用参数 |

## 预期结果

修复完成后预期：
- 错误数量: 173 → < 50
- 警告数量: 58 → < 30
- 代码质量评分: 6/10 → 8/10

## 验证步骤

每完成一个阶段后运行：
1. `npm run lint` - 检查 ESLint 问题
2. `npx tsc --noEmit` - 检查 TypeScript 类型
3. 手动测试相关功能确保没有破坏
