# é—è¿¹æ¢ç´¢é—®é¢˜ä¿®å¤è®¡åˆ’

## é—®é¢˜åˆ—è¡¨

### 1. åŸºåœ°æ ¸å¿ƒä»“åº“ã€ç§‘ç ”æ•°æ®ä¸­å¿ƒä¸åº”è¯¥æœ‰éš¾åº¦æå‡
**é—®é¢˜æè¿°**: è¿™ä¸¤ä¸ªå‰¯æœ¬ç°åœ¨ä¼šé€æ­¥æå‡éš¾åº¦ï¼Œä½†å®ƒä»¬åº”è¯¥åªæœ‰å›ºå®šéš¾åº¦ï¼ˆç®€å•ï¼‰ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:
- ä¿®æ”¹ `GameManager.ts` ä¸­çš„ `challengeRuin` æ–¹æ³•
- åœ¨èƒœåˆ©åˆ¤æ–­æ—¶ï¼Œé™¤äº† `research_star` ç±»å‹å¤–ï¼Œä¹Ÿè¦æ’é™¤ `base_core` ç±»å‹
- è¿™ä¸¤ä¸ªç±»å‹çš„å‰¯æœ¬æˆåŠŸåéƒ½ä¸åº”è¯¥å‡çº§éš¾åº¦

**æ¶‰åŠæ–‡ä»¶**:
- `src/core/GameManager.ts` - `challengeRuin` æ–¹æ³•

---

### 2. å‰¯æœ¬æŒ‘æˆ˜å®Œæˆåä¸ä¼šé‡ç½®ç”Ÿå‘½å€¼
**é—®é¢˜æè¿°**: ä¸‹æ¬¡æŒ‘æˆ˜æ—¶ç»§æ‰¿ä¸Šæ¬¡ç»“æŸæ—¶çš„ç”Ÿå‘½å€¼ï¼Œåº”è¯¥æ¯æ¬¡æŒ‘æˆ˜éƒ½é‡ç½®ä¸ºæ»¡è¡€ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:
- åœ¨ `GenericBattleScreen.tsx` ä¸­ï¼Œæˆ˜æ–—å¼€å§‹å‰éœ€è¦å°†ç©å®¶ç”Ÿå‘½å€¼é‡ç½®ä¸ºæ»¡è¡€
- ä¿®æ”¹ `initPlayerTeam` æ–¹æ³•ï¼Œç¡®ä¿æ¯æ¬¡åˆå§‹åŒ–æ—¶ç©å®¶ HP = maxHp

**æ¶‰åŠæ–‡ä»¶**:
- `src/core/GenericBattleScreen.tsx` - `initPlayerTeam` æ–¹æ³•

---

### 3. å›°éš¾éš¾åº¦çš„å‰¯æœ¬æŒ‘æˆ˜å®Œæˆåæ²¡æœ‰é€€å‡ºæ–¹å¼
**é—®é¢˜æè¿°**: æˆ˜æ–—ç»“æŸåæ²¡æœ‰è¿”å›æŒ‰é’®ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:
- æ£€æŸ¥ `GenericBattleScreen.tsx` ä¸­çš„èƒœåˆ©/å¤±è´¥ç•Œé¢
- ç¡®ä¿æ‰€æœ‰æƒ…å†µä¸‹éƒ½æœ‰"ç¡®è®¤"æŒ‰é’®å¯ä»¥è¿”å›
- æŒ‰é’®ç‚¹å‡»åè°ƒç”¨ `onBattleEnd` å›è°ƒ

**æ¶‰åŠæ–‡ä»¶**:
- `src/core/GenericBattleScreen.tsx` - èƒœåˆ©/å¤±è´¥ç•Œé¢æ¸²æŸ“

---

### 4. æŒ‘æˆ˜å¤±è´¥ä¹Ÿä¼šè¢«è®°å½•ä¸ºå·²å®Œæˆå¹¶æ‰£é™¤æŒ‘æˆ˜æ¬¡æ•°
**é—®é¢˜æè¿°**: å¤±è´¥ä¸åº”è¯¥è®°å½•å®Œæˆæ¬¡æ•°ï¼Œä¹Ÿä¸åº”è¯¥æ‰£é™¤æŒ‘æˆ˜æ¬¡æ•°ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:
- ä¿®æ”¹ `GameManager.ts` ä¸­çš„ `challengeRuin` æ–¹æ³•
- åªæœ‰åœ¨ `isSuccess` ä¸º true æ—¶æ‰å¢åŠ  `completedCount`
- åªæœ‰åœ¨ `isSuccess` ä¸º true æ—¶æ‰æ‰£é™¤æŒ‘æˆ˜æ¬¡æ•°
- ä¿®æ”¹ `updateRuinBattleResult` æ–¹æ³•ï¼Œæ·»åŠ  `isSuccess` å‚æ•°
- ä¿®æ”¹ `RuinsContent.tsx` ä¸­çš„æ‰«è¡é€»è¾‘ï¼Œç¡®ä¿æ‰«è¡åªåœ¨æˆåŠŸæ—¶æ‰£é™¤æ¬¡æ•°

**æ¶‰åŠæ–‡ä»¶**:
- `src/core/GameManager.ts` - `challengeRuin` å’Œ `updateRuinBattleResult` æ–¹æ³•
- `src/screens/baseScreen/RuinsContent.tsx` - æ‰«è¡é€»è¾‘
- `src/screens/baseScreen/index.tsx` - `handleRuinBattleEnd` å›è°ƒ

---

### 5. ç°åœ¨åªå‰©ä¸‹é¦–æ¬¡æŒ‘æˆ˜ï¼Œæ²¡æœ‰æŒ‘æˆ˜å·²å®Œæˆéš¾åº¦å’Œæ‰«è¡çš„æŒ‰é’®
**é—®é¢˜æè¿°**: UIä¸Šç¼ºå°‘å¯¹å·²é€šå…³å‰¯æœ¬çš„æ“ä½œæŒ‰é’®ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:
- ä¿®æ”¹ `RuinsContent.tsx` ä¸­çš„æŒ‰é’®æ˜¾ç¤ºé€»è¾‘
- å¯¹äºå·²é¦–é€šçš„å‰¯æœ¬ï¼Œåº”è¯¥æ˜¾ç¤ºï¼š
  - "æŒ‘æˆ˜"æŒ‰é’® - æŒ‘æˆ˜å½“å‰éš¾åº¦
  - "æ‰«è¡"æŒ‰é’® - å¦‚æœè¿˜æœ‰å‰©ä½™æ¬¡æ•°
- ä¿®æ”¹æŒ‰é’®æ–‡å­—ï¼šé¦–é€šæ—¶æ˜¾ç¤º"é¦–æ¬¡æŒ‘æˆ˜"ï¼Œå·²é€šå…³æ˜¾ç¤º"å¼€å§‹æŒ‘æˆ˜"

**æ¶‰åŠæ–‡ä»¶**:
- `src/screens/baseScreen/RuinsContent.tsx` - æ“ä½œæŒ‰é’®æ¸²æŸ“é€»è¾‘

---

## ä¿®å¤é¡ºåº

1. **ä¿®å¤é—®é¢˜4**ï¼ˆå¤±è´¥æ‰£é™¤æ¬¡æ•°ï¼‰- æ ¸å¿ƒé€»è¾‘ä¿®å¤
2. **ä¿®å¤é—®é¢˜1**ï¼ˆéš¾åº¦æå‡ï¼‰- å‰¯æœ¬ç±»å‹åˆ¤æ–­
3. **ä¿®å¤é—®é¢˜2**ï¼ˆç”Ÿå‘½å€¼é‡ç½®ï¼‰- æˆ˜æ–—ç³»ç»Ÿ
4. **ä¿®å¤é—®é¢˜3**ï¼ˆé€€å‡ºæ–¹å¼ï¼‰- UIå®Œå–„
5. **ä¿®å¤é—®é¢˜5**ï¼ˆæŒ‰é’®æ˜¾ç¤ºï¼‰- UIå®Œå–„

## å…·ä½“ä»£ç ä¿®æ”¹

### 1. GameManager.ts - challengeRuin æ–¹æ³•

```typescript
// ä¿®æ”¹å‰:
ruin.completedCount += 1;
if (!isFirstClear) {
  this.dailyRuinAttempts[ruin.type] = (this.dailyRuinAttempts[ruin.type] || 0) + 1;
}

// ä¿®æ”¹å - åªæœ‰æˆåŠŸæ—¶æ‰è®°å½•:
if (isSuccess) {
  ruin.completedCount += 1;
  if (!isFirstClear) {
    this.dailyRuinAttempts[ruin.type] = (this.dailyRuinAttempts[ruin.type] || 0) + 1;
  }
  
  // éš¾åº¦æå‡é€»è¾‘
  if (ruin.type === RuinType.RESEARCH_STAR || ruin.type === RuinType.BASE_CORE) {
    ruin.firstClear = false;
  } else {
    const nextDifficulty = getNextDifficulty(ruin.currentDifficulty);
    if (nextDifficulty) {
      ruin.currentDifficulty = nextDifficulty;
      ruin.firstClear = true;
      this.dailyRuinAttempts[ruin.type] = 0;
    } else {
      ruin.firstClear = false;
    }
  }
}
```

### 2. GameManager.ts - updateRuinBattleResult æ–¹æ³•

éœ€è¦æ·»åŠ  `isSuccess` å‚æ•°ï¼Œåªæœ‰æˆåŠŸæ—¶æ‰æ›´æ–°çŠ¶æ€ã€‚

### 3. GenericBattleScreen.tsx - initPlayerTeam

```typescript
// ç¡®ä¿æ¯æ¬¡åˆå§‹åŒ–æ—¶ç©å®¶æ»¡è¡€
const stats = calculatePlayerStats();
player.hp = stats.maxHp; // é‡ç½®ä¸ºæ»¡è¡€
```

### 4. RuinsContent.tsx - æŒ‰é’®æ˜¾ç¤ºé€»è¾‘

```typescript
// ä¿®æ”¹æŒ‰é’®æ˜¾ç¤ºé€»è¾‘
{ruin.firstClear ? (
  <button>ğŸ¯ é¦–æ¬¡æŒ‘æˆ˜</button>
) : (
  <>
    <button>âš”ï¸ å¼€å§‹æŒ‘æˆ˜</button>
    {remaining > 0 && <button>æ‰«è¡</button>}
  </>
)}
```
